<?xml version="1.0" encoding="UTF-8" ?>

<!DOCTYPE sqlMap      
    PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN"      
    "http://ibatis.apache.org/dtd/sql-map-2.dtd">

<sqlMap namespace="MyPageStudent">

	<typeAlias alias="Student" type="pro.student.vo.Student"/>
	<typeAlias alias="Enrollment" type="pro.enrollment.vo.Enrollment"/>
	<typeAlias alias="Qna" type="pro.qna.vo.Qna"/>
	<typeAlias alias="Criteria" type="pro.criteria.vo.Criteria"/>

	<select id="getStudentByNo" parameterClass="int" resultClass="Student">
		select
			student_no			no
			,student_name		name
			,student_email		email
			,student_pwd		pwd
			,student_phone		phone
			,student_point		point
			,user_type			type
		from student
		where student_no = #value#
	</select>
	
	<select id="getStudentByEmail" parameterClass="string" resultClass="Student">
		select
			student_no			no
			,student_name		name
			,student_email		email
			,student_pwd		pwd
			,student_phone		phone
			,student_point		point
			,user_type			type
		from student
		where student_email = #value#
	</select>
	
	<select id="getEnrollmentByStudentNo" parameterClass="int" resultClass="Enrollment">
		select
			A.enrollment_no					no
			,A.enrollment_start_date		startDate
			,A.course_no					"course.no"
			,B.course_name					"course.name"
			,B.lecturer_no					"course.lecturer.no"
			,C.lecturer_name				"course.lecturer.name"
		from enrollment A, course B, lecturer C
		where A.course_no = B.course_no
		and B.lecturer_no = C.lecturer_no
		and A.student_no = #value#
	</select>
	
	<select id="getTotalQnaRows" parameterClass="int" resultClass="int">
		select count(*)
		from qna
		where student_no = #value#
		and  qna_active = 'Y'
	</select>
	
	<select id="getQnaByStudentNo" parameterClass="Criteria" resultClass="Qna">
		select 
			A.qna_no 				no
			,A.qna_title			title
			,A.course_no			"course.no"
			,B.course_name			"course.name"
			,A.qna_ques_content 	quesContent
			,A.qna_ques_date		quesDate
			,A.qna_ans_content		ansContent
			,A.qna_ans_regdate		ansRegdate
			,C.lecturer_no			"course.lecture.no"
			,C.lecturer_name		"course.lecture.name"
		from (select row_number() over(order by qna_no desc) rn, qna_no, qna_title, course_no, 
					qna_ques_content, qna_ques_date, qna_ans_content, qna_ans_regdate, student_no, qna_active 
			from qna
			where qna_active = 'Y'
			and student_no = #studentNo#) A, course B, lecturer C
		where A.course_no = B.course_no
		and B.lecturer_no = C.lecturer_no
		<dynamic>
			<isNotNull property="opt">
				<isNotNull property ="keyword">
					<isEqual property="opt" compareValue="title">
						and A.qna_title like '%' || #keyword# || '%'
					</isEqual>
					<isEqual property="opt" compareValue="course">
						and B.course_name like '%' || #keyword# || '%'					
					</isEqual>
					<isEqual property="opt" compareValue="lecturer">
						and C.lecturer_name like '%' || #keyword# || '%'
					</isEqual>
				</isNotNull>
			</isNotNull>
			<isNotNull property="noAnswer">
				<isEqual property="noAnswer" compareValue="N">
						and A.qna_ans_content is not null
				</isEqual>
				<isEqual property="noAnswer" compareValue="Y">
						and A.qna_ans_content is null
				</isEqual>
			</isNotNull>
		</dynamic>
		<![CDATA[
			and rn >= #beginIndex#
			and rn <= #endIndex#
		]]>
	</select>
	
	<update id="updateMyInfo" parameterClass="Student">
		update student
		set
			student_pwd = #pwd#
			,student_phone = #phone#
		where student_no = #no#
	</update>
</sqlMap>