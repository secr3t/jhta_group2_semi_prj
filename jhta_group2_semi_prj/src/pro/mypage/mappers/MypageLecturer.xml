<?xml version="1.0" encoding="UTF-8" ?>

<!DOCTYPE sqlMap      
    PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN"      
    "http://ibatis.apache.org/dtd/sql-map-2.dtd">

<sqlMap namespace="MyPageLecturer">

	<typeAlias alias="Lecturer" type="pro.lecturer.vo.Lecturer"/>
	<typeAlias alias="Course" type="pro.course.vo.Course"/>
	<typeAlias alias="Qna" type="pro.qna.vo.Qna"/>
	<typeAlias alias="Criteria" type="pro.criteria.vo.Criteria"/>
	
	<select id="getLecturerByNo" parameterClass="int" resultClass="Lecturer">
		select
			lecturer_no			no
			,lecturer_name		name
			,lecturer_email		email
			,lecturer_pwd		pwd
			,lecturer_phone		phone
			,lecturer_career	career
			,lecturer_picture	picture
			,lecturer_permit	permit
			,user_type			type	
		from lecturer
		where lecturer_no = #value#
	</select>
	
	<select id="getLecturerByEmail" parameterClass="string" resultClass="Lecturer">
		select
			lecturer_no			no
			,lecturer_name		name
			,lecturer_email		email
			,lecturer_pwd		pwd
			,lecturer_phone		phone
			,lecturer_career	career
			,lecturer_picture	picture
			,lecturer_permit	permit
			,user_type			type	
		from lecturer
		where lecturer_email = #value#
	</select>
	
	<select id="getTotalCourseRows" parameterClass="int" resultClass="int">
		select count(*)
		from course
		where lecturer_no = #value#
	</select>
	
	<select id="getCourseByLecturerNo" parameterClass="Criteria" resultClass="Course">
		select
			B.course_no			no
			,B.course_name		name
			,B.course_summary		summary
			,B.course_detail		detail
			,B.course_point		point
			,B.dept_no			"dept.no"
		from (select row_number() over(order by course_no desc) rn, course_no ,course_name
					,course_summary ,course_detail ,course_point ,dept_no
			from course) A, course B 
		where A.course_no = B.course_no
		and B.lecturer_no = #lecturerNo#
		<![CDATA[
			and A.rn >= #beginIndex#
			and A.rn <= #endIndex#
		]]>
	</select>
	
	<select id="getQnaByLecturerNo" parameterClass="Criteria" resultClass="Qna">
		select
			A.qna_no 				no
			,A.qna_title			title
			,A.course_no			"course.no"
			,B.course_name			"course.name"
			,A.qna_ques_content 	quesContent
			,A.qna_ques_date		quesDate
			,A.qna_ans_content		ansContent
			,A.qna_ans_regdate		ansRegdate
			,C.student_no			"student.no"
			,C.student_name			"student.name"
		from(select row_number() over(order by qna_no desc) rn, qna_no, qna_title, course_no, 
							qna_ques_content, qna_ques_date, qna_ans_content, qna_ans_regdate, student_no, qna_active 
			from qna
			where qna_active = 'Y'
			and course_no in (select course_no
							from course
							where lecturer_no = #lecturerNo#)) A, course B, student C
		where A.course_no = B.course_no
		and A.student_no = C.student_no
		<dynamic>
			<isNotNull property="opt">
				<isNotNull property ="keyword">
					<isEqual property="opt" compareValue="title">
						and A.qna_title like '%' || #keyword# || '%'
					</isEqual>
					<isEqual property="opt" compareValue="course">
						and B.course_name like '%' || #keyword# || '%'					
					</isEqual>
					<isEqual property="opt" compareValue="student">
						and C.student_name like '%' || #keyword# || '%'
					</isEqual>
				</isNotNull>
			</isNotNull>
			<isNotNull property="noAnswer">
				<isEqual property="noAnswer" compareValue="N">
						and A.qna_ans_content is not null
				</isEqual>
				<isEqual property="noAnswer" compareValue="Y">
						and A.qna_ans_content is null
				</isEqual>
			</isNotNull>
		</dynamic>
		<![CDATA[
			and rn >= #beginIndex#
			and rn <= #endIndex#
		]]>
	</select>
	
	<update id="updateMyInfo" parameterClass="Lecturer">
		update lecturer
		set
			lecturer_pwd = #pwd#
			,lecturer_phone = #phone#
			,lecturer_career = #career#
			,lecturer_picture = #picture#
		where lecturer_no = #no#
	</update>	
</sqlMap>